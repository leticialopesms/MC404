extern int _system_time;

void sleep(int ms){
    int init = _system_time;
    while (_system_time - init < ms){ 
        /* waiting */
    }
    return;
}

void play_note(int ch, int inst, int note, int vel, int dur);

const int insts[12] = {0, 30, 0, 40, 0, 45, 0, 0, 0, 0, 35, 25};
int notas[47][6] = {{0, 240, 4, 0, 38, 95},    // D
                    {240, 480, 4, 0, 38, 95},    // D
                    {480, 720, 4, 0, 38, 95},    // D
                    {720, 960, 4, 9, 45, 95},    // A
                    {960, 1200, 4, 8, 44, 95},   // G#
                    {1200, 1440, 4, 7, 43, 95},  // G
                    {1440, 1680, 4, 5, 41, 95},  // F
                    {1680, 1920, 4, 0, 38, 95},  // D
                    {1920, 2160, 4, 7, 43, 95},  // F
                    {2160, 2400, 4, 5, 41, 95},  // E
                    {2400, 2640, 4, 2, 38, 95},  // B
                    {2640, 2880, 4, 2, 38, 95},  // B
                    {2880, 3120, 4, 9, 45, 95},  // A
                    {3120, 3360, 4, 0, 38, 95},  // D
                    {3360, 3600, 4, 8, 44, 95},  // G#
                    {3600, 3840, 4, 7, 43, 95},  // G
                    {3840, 4080, 4, 0, 38, 95},  // D
                    {4080, 4320, 4, 7, 43, 95},  // F
                    {4320, 4560, 4, 5, 41, 95},  // E
                    {4560, 4800, 4, 2, 38, 95},  // B
                    {4800, 5040, 4, 2, 38, 95},  // B
                    {5040, 5280, 4, 9, 45, 95},  // A
                    {5280, 5520, 4, 0, 38, 95},  // D
                    {5520, 5760, 4, 8, 44, 95},  // G#
                    {5760, 6000, 4, 7, 43, 95},  // G
                    {6000, 6240, 4, 0, 38, 95},  // D
                    {6240, 6480, 4, 7, 43, 95},  // F
                    {6480, 6720, 4, 5, 41, 95},  // E
                    {6720, 6960, 4, 2, 38, 95},  // B
                    {6960, 7200, 4, 2, 38, 95},  // B
                    {7200, 7440, 4, 9, 45, 95},  // A
                    {7440, 7680, 4, 0, 38, 95},  // D
                    {7680, 7920, 4, 8, 44, 95},  // G#
                    {7920, 8160, 4, 7, 43, 95},  // G
                    {8160, 8400, 4, 0, 38, 95},  // D
                    {8400, 8640, 4, 7, 43, 95},  // F
                    {8640, 8880, 4, 5, 41, 95},  // E
                    {8880, 9120, 4, 2, 38, 95},  // B
                    {9120, 9360, 4, 2, 38, 95},  // B
                    {9360, 9600, 4, 9, 45, 95},  // A
                    {9600, 9840, 4, 0, 38, 95},  // D
                    {9840, 10080, 4, 8, 44, 95}, // G#
                    {10080, 10320, 4, 7, 43, 95},// G
                    {10320, 10560, 4, 0, 38, 95},// D
                    {10560, 10800, 4, 7, 43, 95},// F
                    {10800, 11040, 4, 5, 41, 95},// E
                    {11040, 11280, 4, 2, 38, 95},// B
                    {11280, 11520, 4, 2, 38, 95}};// B

                    
int main(){
    int bpm = 144;
    int ticks = 960;
    int last_ini = 0;

    for (int i = 0; i < 47; i++){
        notas[i][0] = (notas[i][0]*6000)/(bpm*(ticks/10));
        notas[i][1] = (notas[i][1]*6000)/(bpm*(ticks/10));
    }

    while (1){
        last_ini = 0;
        for (int i = 0; i < 47; i++){
            sleep(notas[i][0] - last_ini); 
            last_ini = notas[i][0];
            play_note(notas[i][3], insts[notas[i][3]], notas[i][4], notas[i][5], notas[i][1] - notas[i][0]);
        }
    }

    return 0;
}
